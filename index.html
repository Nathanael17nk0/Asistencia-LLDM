<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>LLDM Asistencia</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css?v=2">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- PWA Manifest & Icons -->
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json?v=6.29">
    <link rel="icon" type="image/png" href="img/favicon-blue.png">
    <link rel="apple-touch-icon" sizes="192x192" href="img/icon-blue-192.png">

    <!-- iOS Fullscreen & Status Bar -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Asistencia">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        /* CRITICAL UI FIX - Force Load */
        .input-row {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .input-row .input-group {
            flex: 1;
        }

        @media (max-width: 700px) {
            .input-row {
                flex-direction: column !important;
                gap: 15px !important;
            }
        }

        /* LOGO SIZE OVERRIDE (v6) */
        .logo-icon {
            font-size: 6rem !important;
            /* Bigger Flame */
            filter: drop-shadow(0 0 15px rgba(255, 165, 0, 0.8));
            /* Glow */
        }

        @media (max-width: 480px) {
            .logo-icon {
                font-size: 5rem !important;
                /* Mobile Size */
            }
        }
    </style>
</head>

<body>

    <div class="background-globes">
        <div class="globe globe-1"></div>
        <div class="globe globe-2"></div>
        <div class="globe globe-3"></div>
    </div>

    <div class="app-container">
        <!-- Register Section (Default) -->
        <section id="register-section" class="active-section centered-login">
            <div class="logo-area main-logo">
                <i class="ri-fire-fill logo-icon"></i>
            </div>

            <div class="glass-card login-card floating-entry">
                <div class="card-header">
                    <h1>LLDM</h1>
                    <p>REGISTRO DE PERSONAL</p>
                </div>
                <form id="register-form">
                    <div class="input-row">
                        <div class="input-group">
                            <i class="ri-user-line"></i>
                            <input type="text" id="reg-nombre" placeholder="Nombre" required>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <i class="ri-user-3-line"></i>
                            <input type="text" id="reg-paterno" placeholder="Apellido Paterno" required>
                        </div>
                        <div class="input-group">
                            <i class="ri-user-3-line"></i>
                            <input type="text" id="reg-materno" placeholder="Apellido Materno" required>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <i class="ri-calendar-line"></i>
                            <input type="date" id="reg-dob" required title="Fecha de Nacimiento">
                        </div>
                        <div class="input-group disabled-group">
                            <i class="ri-hourglass-line"></i>
                            <input type="text" id="reg-edad" placeholder="Edad" readonly>
                        </div>
                    </div>

                    <div class="input-group">
                        <i class="ri-map-pin-line"></i>
                        <input type="text" id="reg-colonia" placeholder="Colonia/Barrio" required>
                    </div>

                    <div class="input-group">
                        <i class="ri-smartphone-line"></i>
                        <input type="tel" id="reg-celular" placeholder="Número Celular" required>
                    </div>

                    <div class="input-group">
                        <i class="ri-lock-2-line"></i>
                        <input type="password" id="reg-password" placeholder="Crear Contraseña" required>
                        <i class="ri-eye-line password-toggle" id="toggle-reg-pass"></i>
                    </div>

                    <button type="submit" class="cyber-btn">
                        <span class="btn-content">REGISTRARME <i class="ri-arrow-right-line"></i></span>
                    </button>

                    <p class="switch-link">¿Ya tienes cuenta? <a href="#" id="show-login"
                            onclick="if(window.appShowLogin) window.appShowLogin(); return false;">Iniciar Sesión</a>
                    </p>
                </form>
            </div>
        </section>

        <!-- Login Section -->
        <section id="login-section" class="hidden-section centered-login">
            <div class="logo-area main-logo">
                <i class="ri-fire-fill logo-icon"></i>
            </div>

            <div class="glass-card login-card floating-entry">
                <div class="card-header">
                    <h1>LLDM</h1>
                    <p>VERIFICACIÓN DE ASISTENCIA</p>
                </div>
                <form id="login-form" onsubmit="event.preventDefault(); return false;">
                    <div class="input-group">
                        <i class="ri-smartphone-line"></i>
                        <input type="tel" id="login-phone" placeholder="Número Celular" required>
                    </div>
                    <div class="input-group">
                        <i class="ri-lock-2-line"></i>
                        <input type="password" id="login-password" placeholder="Contraseña" required>
                    </div>
                    <button type="button"
                        onclick="if(window.appHandleLogin) { window.appHandleLogin(event); } else { alert('El sistema aún está cargando...'); }"
                        class="cyber-btn">
                        <span class="btn-content">INGRESAR <i class="ri-arrow-right-line"></i></span>
                        <span class="btn-glitch"></span>
                    </button>
                    <div id="login-error" class="error-msg hidden">Acceso Denegado</div>

                    <p class="switch-link">¿Nuevo aquí? <a href="#" id="show-register">Crear Cuenta</a></p>
                </form>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard-section" class="hidden-section full-screen-dashboard">
            <!-- Floating User Info (Top Right) -->
            <div class="user-float-card glass-card">
                <div class="user-details">
                    <h2 id="user-name">Usuario</h2>
                    <span class="status-badge online">EN LÍNEA</span>
                </div>
                <div class="avatar-small">
                    <img src="https://ui-avatars.com/api/?name=User&background=c5a059&color=fff" id="user-avatar"
                        alt="User">
                </div>
                <button id="logout-btn" class="mini-icon-btn"><i class="ri-shut-down-line"></i></button>
            </div>

            <!-- Main Center Action -->
            <div class="center-stage">
                <!-- Theme of the Week -->
                <div id="theme-display" class="theme-banner">
                    <!-- Added Floating Flame -->
                    <i class="ri-fire-fill logo-icon"
                        style="font-size: 2.5rem !important; margin-bottom: 10px; display:block; animation: pulse-gold 3s infinite ease-in-out;"></i>
                    <p class="theme-label">TEMA DE LA SEMANA:</p>
                    <h3 id="current-theme-text">LA RESTAURACIÓN DE LA IGLESIA</h3>
                </div>

                <div class="fingerprint-container" id="check-in-btn">
                    <div class="scan-line"></div>
                    <i class="ri-fingerprint-2-line fingerprint-icon"></i>
                    <div class="ring"></div>
                    <div class="ring delay"></div>
                </div>
                <p class="instruction-text">Cargando...</p>

                <!-- NEW: View Roles Button for Users -->
                <!-- NEW: View Roles Button for Users -->
                <button id="user-view-schedule-btn" class="cyber-btn sm light-blue" style="margin-top:20px;"
                    onclick="window.manuallyOpenSchedule()">
                    <i class="ri-calendar-check-line"></i> LISTA DE ORACIONES
                </button>

                <!-- Hidden Success Message Area -->
                <div id="success-message" class="success-popup hidden">
                    <i class="ri-checkbox-circle-fill"></i>
                    <h3>ASISTENCIA REGISTRADA</h3>
                    <p>Hora: <span id="time-stamp">--:--</span></p>
                </div>
            </div>

            <!-- Admin Controls (Bottom Left) -->
            <div id="admin-controls" class="admin-controls hidden">
                <button id="admin-toggle" class="cyber-btn sm">ADMIN <i class="ri-settings-3-line"></i></button>
            </div>

            <!-- REPORT COMPONENT -->
            <div id="reports-overlay" class="hidden"
                style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; display:none; align-items:center; justify-content:center;">
                <div class="cyber-card"
                    style="width:90%; max-width:500px; max-height:90vh; overflow-y:auto; position:relative;">
                    <button onclick="toggleReportsModal()"
                        style="position:absolute; top:10px; right:10px; background:transparent; border:none; color:white; font-size:1.5rem;">&times;</button>
                    <h3 class="gradient-text" style="text-align:center;">GENERAR REPORTES</h3>

                    <div style="margin-top:20px;">
                        <label style="color:#aaa;">Rango de Fechas:</label>
                        <div class="input-row" style="margin-top:5px;">
                            <input type="date" id="report-start" class="simple-input" style="flex:1;">
                            <input type="date" id="report-end" class="simple-input" style="flex:1;">
                        </div>
                        <div style="display:flex; gap:5px; margin-top:10px; justify-content:center;">
                            <button onclick="setReportDate('today')" class="cyber-btn sm"
                                style="font-size:0.7rem; padding:5px 10px;">HOY</button>
                            <button onclick="setReportDate('week')" class="cyber-btn sm"
                                style="font-size:0.7rem; padding:5px 10px;">ESTA SEMANA</button>
                            <button onclick="setReportDate('month')" class="cyber-btn sm"
                                style="font-size:0.7rem; padding:5px 10px;">ESTE MES</button>
                        </div>
                    </div>

                    <div style="margin-top:20px; text-align:center;">
                        <button onclick="generateReportPreview()" class="cyber-btn" style="width:100%;">GENERAR VISTA
                            PREVIA</button>
                    </div>

                    <!-- PREVIEW AREA -->
                    <div id="report-preview"
                        style="margin-top:20px; padding:10px; background:rgba(255,255,255,0.05); border-radius:10px; min-height:100px;">
                        <p style="color:#666; text-align:center;">Selecciona fechas y genera un reporte.</p>
                    </div>

                    <div style="margin-top:20px; text-align:center;">
                        <button id="btn-export-excel" onclick="exportReportToExcel()" class="cyber-btn sm"
                            style="background:#2ecc71 !important; width:100%; display:none;">
                            <i class="ri-file-excel-2-line"></i> DESCARGAR EXCEL
                        </button>
                    </div>
                </div>
            </div>

            <!-- Admin Panel Overlay (Single Page Container) -->
            <!-- Admin Panel Overlay (Single Page Container) -->
            <!-- SERVICE SELECTION MODAL (New) -->
            <div id="service-select-modal" class="hidden"
                style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:3500; display:none; align-items:center; justify-content:center;">
                <div class="cyber-card" style="width:90%; max-width:400px; text-align:center;">
                    <h3 class="gradient-text" style="margin-bottom:20px;">SELECCIONA CULTO</h3>
                    <div id="service-options-container" style="display:flex; flex-direction:column; gap:10px;">
                        <!-- Buttons will be injected here or hardcoded -->
                    </div>
                    <button onclick="closeServiceModal()" class="cyber-btn sm danger"
                        style="margin-top:20px; width:100%;">CANCELAR</button>
                </div>
            </div>

            <!-- Admin Panel Overlay (Fixed Layout) -->
            <div id="admin-panel" class="admin-only hidden"
                style="position:fixed; top:0; left:0; width:100%; height:100vh; z-index:2001; background: rgba(255,255,255,0.98);">

                <!-- FIXED HEADER CONTAINER -->
                <div class="admin-fixed-header">
                    <!-- HEADER & REPORTS -->
                    <div
                        style="padding: 10px; border-bottom: 1px solid #eee; background: linear-gradient(135deg, #4169E1 0%, #0047AB 100%); display:flex; flex-direction:column; gap:5px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                            <div style="display:flex; align-items:center; gap:5px;">
                                <h4 style="margin:0; color:white; font-size:1rem;">PANEL ADMIN</h4>
                                <!-- Added Mini Flame -->
                                <i class="ri-fire-fill logo-icon"
                                    style="font-size: 1.2rem !important; margin:0; animation: pulse-gold 3s infinite ease-in-out;"></i>
                            </div>
                            <button id="close-admin-btn" class="cyber-btn sm danger"
                                style="font-size:0.7rem; padding: 2px 8px;">CERRAR</button>
                        </div>

                        <div style="display:flex; gap:5px; width:100%;">
                            <button id="admin-view-schedule-btn-force" class="cyber-btn sm"
                                onclick="window.manuallyOpenSchedule();"
                                style="flex:1; background:#f1c40f; color:black; font-weight:bold; border:2px solid orange;">
                                <i class="ri-calendar-check-line"></i> VER ROLES
                            </button>
                            <button onclick="toggleReportsModal()" class="cyber-btn sm" style="flex:1;">
                                <i class="ri-file-chart-line"></i> REPORTES
                            </button>
                        </div>
                    </div>

                    <!-- 1. OCR Section (Roles) -->
                    <div class="admin-section" style="padding: 10px; border-bottom: 1px solid #eee;">
                        <h5 style="margin-bottom:5px; font-weight:bold; font-size:0.9rem;"><i
                                class="ri-camera-lens-line"></i> Actualizar
                            Roles</h5>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="file" id="schedule-file-input" accept="image/*, .xlsx, .xls"
                                style="display:none;">
                            <button id="upload-schedule-btn" class="cyber-btn sm"
                                style="font-size:0.8rem; padding: 5px 15px; width:100%;"><i
                                    class="ri-upload-cloud-line"></i> Subir
                                Foto</button>
                            <!-- REMOVED TRASH BUTTON as requested -->
                            <div id="ocr-status" class="hidden" style="font-size:0.8rem; color:#0066cc;"></div>
                        </div>
                    </div>

                    <!-- 2. Theme Section (Thinner) -->
                    <div class="admin-section" style="padding: 2px 10px; border-bottom: 1px solid #eee;">
                        <div class="input-group" style="display:flex; gap:5px; margin-top:0;">
                            <input type="text" id="admin-theme-input" placeholder="Tema Semanal..." class="simple-input"
                                style="border:1px solid #ccc; flex:1; padding: 2px 5px; font-size:0.8rem; height:24px;">
                            <button id="save-theme-btn" class="cyber-btn sm"
                                style="font-size:0.75rem; padding:0 10px; height:24px; line-height:24px;">GUARDAR</button>
                        </div>
                    </div>

                    <!-- 3. Registration Section (Minimized) -->
                    <div class="admin-section"
                        style="padding: 10px 15px; border-bottom: 1px solid #eee; background:#f9f9f9;">
                        <button onclick="document.getElementById('admin-manual-form').classList.toggle('hidden')"
                            class="cyber-btn sm secondary" style="width:100%; font-size:0.8rem;">
                            <i class="ri-user-add-line"></i> REGISTRO RÁPIDO (DESPLEGAR)
                        </button>
                        <!-- Manual Registration Form (Admin) -->
                        <div id="admin-manual-form" class="hidden" style="margin-top:10px;">
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <input type="text" id="admin-reg-nombre" placeholder="Nombre" class="simple-input"
                                    style="flex:1;">
                                <input type="text" id="admin-reg-paterno" placeholder="Ap. Paterno" class="simple-input"
                                    style="flex:1;">
                            </div>
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <input type="text" id="admin-reg-materno" placeholder="Ap. Materno" class="simple-input"
                                    style="flex:1;">
                                <input type="tel" id="admin-reg-celular" placeholder="Celular (ID)" class="simple-input"
                                    style="flex:1;">
                            </div>
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <input type="text" id="admin-reg-colonia" placeholder="Colonia" class="simple-input"
                                    style="flex:1;">
                                <input type="date" id="admin-reg-dob" class="simple-input" style="flex:1;">
                            </div>
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <input type="text" id="admin-reg-edad" placeholder="Edad" readonly class="simple-input"
                                    style="width:60px; background:#eee;">
                                <input type="text" id="admin-reg-pass" placeholder="Pass (Opcional)"
                                    class="simple-input" style="flex:1;">
                                <input type="hidden" id="editing-user-id">
                            </div>
                            <button id="manual-register-btn" class="cyber-btn sm"
                                style="width:100%; margin-top:5px;">REGISTRAR HERMANO</button>
                            <button id="cancel-edit-btn" class="cyber-btn sm secondary hidden"
                                style="width:100%; margin-top:5px;">CANCELAR EDICIÓN</button>
                        </div>
                    </div>

                    <!-- 4. Filter Section (Sticky) -->
                    <div class="admin-section"
                        style="padding: 10px 15px; background:white; border-bottom:1px solid #eee;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <h5 style="margin:0; font-weight:bold;"><i class="ri-list-check"></i> Asistencia Actual</h5>
                            <div id="attendance-count"
                                style="background:var(--primary); color:white; padding:2px 8px; border-radius:10px; font-size:0.8rem;">
                                0/0</div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="admin-search-user" placeholder="Buscar..." class="simple-input"
                                style="flex:1; padding:5px;">
                            <select id="admin-service-filter" class="simple-input" style="width:100px; padding:5px;">
                                <option value="all">Todos</option>
                                <option value="5am">5am</option>
                                <option value="9am">9am</option>
                                <option value="10am_dom">10am</option>
                                <option value="6pm_jue">6pm</option>
                                <option value="6pm_dom">6pm</option>
                                <option value="7pm">7pm</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- SCROLLABLE LIST -->
                <div class="admin-scrollable-content">
                    <div id="admin-user-list" style="border:1px solid #eee; min-height:200px;">
                        <!-- Users injected here -->
                    </div>

                    <!-- 5. Configuration (Location) - At bottom of list -->
                    <div class="admin-section"
                        style="padding: 15px; margin-top:20px; border-top: 1px solid #eee; background:#fafafa;">
                        <h5 style="margin-bottom:5px; font-weight:bold;"><i class="ri-map-pin-user-line"></i> Ubicación
                            Iglesia</h5>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span id="location-status-admin" style="font-size:0.7rem; font-family:monospace;">--</span>
                            <button id="set-location-btn" class="cyber-btn sm" style="font-size:0.7rem;">FIJAR
                                AQUÍ</button>
                        </div>
                    </div>
                    <div style="height:150px;"></div> <!-- Extra padding for scroll -->
                </div>
            </div>

            <!-- Schedule/Image Overlay -->
            <div id="schedule-overlay" class="glass-overlay hidden" style="z-index:3000; overflow-y:auto;">
                <button id="close-schedule"
                    style="position:absolute; top:20px; right:20px; font-size:2rem; background:none; border:none; color:white;">&times;</button>

                <div style="padding:20px; color:white; text-align:center;">
                    <h2 class="gradient-text">ROLES DE SERVICIO</h2>

                    <!-- Weekly Table Container -->
                    <div id="weekly-table-container" class="hidden" style="margin-top:20px; overflow-x:auto;">
                        <table
                            style="width:100%; border-collapse:collapse; min-width:600px; background:rgba(255,255,255,0.1); border-radius:10px;">
                            <thead>
                                <tr style="background:var(--primary-gold); color:black;">
                                    <th style="padding:15px; border-bottom:2px solid rgba(0,0,0,0.2);">DÍA</th>
                                    <th style="padding:15px; border-bottom:2px solid rgba(0,0,0,0.2);">5:00 AM</th>
                                    <th style="padding:15px; border-bottom:2px solid rgba(0,0,0,0.2);">9:00 AM</th>
                                    <th style="padding:15px; border-bottom:2px solid rgba(0,0,0,0.2);">7:00 PM</th>
                                    <th style="padding:15px; border-bottom:2px solid rgba(0,0,0,0.2);">ESPECIAL</th>
                                </tr>
                            </thead>
                            <tbody id="weekly-tbody">
                                <!-- JS fills this -->
                            </tbody>
                        </table>
                        <button id="back-to-today" class="cyber-btn sm" style="margin-top:20px;">VER HOY</button>
                    </div>

                    <div class="schedule-grid">
                        <!-- Cards for Today -->
                        <div class="schedule-card" data-slot="5am">
                            <h4>ORACIÓN 5:00 AM</h4>
                            <p class="assigned-name">--</p>
                            <button class="edit-role-btn hidden"><i class="ri-pencil-line"></i></button>
                        </div>
                        <div class="schedule-card" data-slot="9am">
                            <h4>ORACIÓN 9:00 AM</h4>
                            <p class="assigned-name">--</p>
                            <button class="edit-role-btn hidden"><i class="ri-pencil-line"></i></button>
                        </div>
                        <div class="schedule-card" data-slot="7pm">
                            <h4>ORACIÓN 7:00 PM</h4>
                            <p class="assigned-name">--</p>
                            <button class="edit-role-btn hidden"><i class="ri-pencil-line"></i></button>
                        </div>
                        <div class="schedule-card" data-slot="special">
                            <h4>CONSAGRACIÓN ESPECIAL</h4>
                            <p class="assigned-name">--</p>
                            <button class="edit-role-btn hidden"><i class="ri-pencil-line"></i></button>
                        </div>
                    </div>

                    <button id="view-weekly-btn" class="cyber-btn" style="margin-top:30px; border: 1px solid white;">VER
                        SEMANA COMPLETA</button>
                </div>
            </div>

            <!-- HISTORY MODAL (New) -->
            <div id="history-modal" class="hidden"
                style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:4000; display:none; align-items:center; justify-content:center;">
                <div class="cyber-card" style="width:90%; max-width:400px; max-height:80vh; overflow-y:auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 class="gradient-text" style="margin:0;">HISTORIAL</h3>
                        <button
                            onclick="document.getElementById('history-modal').classList.add('hidden'); document.getElementById('history-modal').style.display='none';"
                            style="background:none; border:none; color:var(--text-muted); font-size:1.5rem;">&times;</button>
                    </div>
                    <div id="history-content" style="font-size:0.9rem;">
                        <!-- Content Injected Here -->
                    </div>
                </div>
            </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- INLINE SUPABASE CONFIG & DEBUG -->
    <script>
        const SUPABASE_URL = "https://pmdqpkucejctdodmkoym.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtZHFwa3VjZWpjdGRvZG1rb3ltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NjM2MzMsImV4cCI6MjA4NjAzOTYzM30.KYOCRTl3y0kIQsCc5QK7uPcsxYfhus_sSuUVzv1mvNU";

        // Visual Status Bar
        const statusDiv = document.createElement('div');
        statusDiv.id = 'sys-status';
        statusDiv.style.cssText = "position:fixed; top:0; left:0; width:100%; padding:5px; text-align:center; color:white; font-size:12px; z-index:9999; font-family:monospace; pointer-events:none;";
        statusDiv.style.background = "rgba(255, 0, 0, 0.8)"; // Default Red
        statusDiv.innerHTML = "⏳ CONECTANDO A LA NUBE...";
        document.body.appendChild(statusDiv);

        function updateStatus(msg, color) {
            const el = document.getElementById('sys-status');
            if (el) {
                el.innerHTML = msg;
                el.style.background = color;
                // Auto hide if green
                if (color.includes('green') || color.includes('#2ecc71')) {
                    setTimeout(() => el.style.display = 'none', 5000);
                }
            }
        }

        window.onerror = function (msg, url, lineNo, columnNo, error) {
            const string = msg.toLowerCase();
            const substring = "script error";
            if (string.indexOf(substring) > -1) {
                updateStatus('❌ Error de Script (Ver Consola)', 'red');
            } else {
                updateStatus(`❌ Error: ${msg} (Línea ${lineNo})`, 'red');
            }
            return false;
        };

        function initSupabaseDirect() {
            if (window.sbClient) return;

            if (window.supabase) {
                try {
                    window.sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log("✅ Supabase INIT (Inline)");
                    updateStatus("✅ NUBE CONECTADA", "#2ecc71"); // Green
                } catch (e) {
                    console.error("Supabase Init Error:", e);
                    updateStatus("❌ ERROR CONFIG NUBE: " + e.message, "red");
                }
            } else {
                updateStatus("⚠️ LIBRERÍA SUPABASE NO CARGADA", "orange");
                setTimeout(initSupabaseDirect, 500);
            }
        }

        // Run immediately and on load
        initSupabaseDirect();
        window.addEventListener('load', initSupabaseDirect);
    </script>

    <!-- Service & App (v6.47 Rewritten) -->
    <script src="js/supabase-config.js?v=6.47"></script>
    <script src="js/supabase-service.js?v=6.47"></script>
    <script src="js/app_v6_42.js?v=6.47"></script>

    <!-- Version Indicator is handled by JS but fallback here -->

    <script>
        // Fallback: If app doesn't init in 2 seconds, force show login
        setTimeout(() => {
            const login = document.getElementById('login-section');
            const dash = document.getElementById('dashboard-section');
            const reg = document.getElementById('register-section');
            const loading = document.getElementById('loading-screen');

            // Check if any main section is visible
            const isAnyVisible = [login, dash, reg].some(el => el && !el.classList.contains('hidden-section'));

            if (!isAnyVisible) {
                console.warn("App init timeout - Forcing Login View");
                if (loading) loading.style.display = 'none';
                if (login) {
                    login.classList.remove('hidden-section');
                    login.style.display = 'flex';
                }
            }
        }, 2000);
    </script>
</body>

</html>